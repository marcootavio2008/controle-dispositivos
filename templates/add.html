{% extends "base.html" %}
{% block title %}Dash Residencial{% endblock %}
{% block page_title %} + dispositivos{% endblock %}
{% block content %}

<div class="add-device-container">
    <h2>Adicionar Dispositivo</h2>

    <div class="hud-line"></div>

    <!-- Nome do dispositivo -->
    <div class="field">
        <label>Nome do dispositivo</label>
        <input 
            type="text" 
            placeholder="Ex: Lâmpada da Mesa"
            id="device-name">
    </div>

    <!-- Tipo de acionamento -->
    
    <div class="field">
    <label>Tipo de dispositivo</label>
    <select id="device-type" class="selector">
        <option value="">Selecione...</option>
        <option value="lan">LAN</option>
        <option value="arduino">Arduino</option>
        <option value="tuya">Lâmpada wifi</option>
    </select>
</div>

<!-- LAN -->
<div class="field device-config" id="config-lan">
    <label>Endereço MAC</label>
    <input type="text" placeholder="AA:BB:CC:DD:EE:FF">
</div>

<!-- Arduino -->
<div class="field device-config" id="config-arduino">
    <label>Porta COM</label>
    <input type="text" placeholder="COM3">

    <label>Pino</label>
    <input type="number" placeholder="13">
</div>

<!-- Tuya -->
<div class="field device-config" id="config-tuya">
    <label>IP do dispositivo</label>
    <input type="text" placeholder="192.168.0.50">
</div>

</div>
    <button class="add-btn">Adicionar</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('device-type');
    const configs = document.querySelectorAll('.device-config');

    select.addEventListener('change', () => {
        configs.forEach(c => c.style.display = 'none');

        const selected = select.value;
        if (selected) {
            const active = document.getElementById(`config-${selected}`);
            if (active) active.style.display = 'block';
        }
    });
});


document.querySelector('.add-btn').addEventListener('click', () => {
    const name = document.getElementById('device-name').value;
    const type = document.getElementById('device-type').value;

    let config = {};

    if (type === "lan") {
        config.mac = document.querySelector('#config-lan input').value;
    }

    if (type === "arduino") {
        const inputs = document.querySelectorAll('#config-arduino input');
        config.port = inputs[0].value;
        config.pin = inputs[1].value;
    }

    if (type === "tuya") {
        config.ip = document.querySelector('#config-tuya input').value;
    }

    fetch('/api/devices', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name,
            device_type: type,
            trigger: "toggle",
            config
        })
    }).then(res => res.json())
      .then(() => window.location.href = "/");
});


</script>
{% endblock %}