{% extends "base.html" %}
{% block title %}Dash Residencial{% endblock %}
{% block page_title %} + dispositivos{% endblock %}
{% block content %}

<div class="add-device-container">
    <h2>Adicionar Dispositivo</h2>
    <input type="hidden" id="user_id" value="{{ user_id }}">
    <input type="hidden" id="house_id" value="{{ house_id }}">


    <div class="hud-line"></div>

    <!-- Nome do dispositivo -->
    <div class="field">
        <label>Nome do dispositivo</label>
        <input 
            type="text" 
            placeholder="Ex: Lâmpada da Mesa"
            id="device-name">
    </div>

    <!-- Tipo de acionamento -->
    
    <div class="field">
    <label>Tipo de dispositivo</label>
    <select id="device-type" class="selector">
        <option value="">Selecione...</option>
        <option value="lan">LAN</option>
        <option value="arduino">Arduino</option>
        <option value="tuya">Lâmpada wifi</option>
    </select>
</div>


<!-- LAN -->
<div class="field device-config" id="config-lan">
    <label>Endereço MAC</label>
    <input type="text" placeholder="AA:BB:CC:DD:EE:FF">
</div>

<!-- Arduino -->
<div class="field device-config" id="config-arduino">
    <label>Porta COM</label>
    <input type="text" placeholder="COM3">

    <label>Pino</label>
    <input type="number" placeholder="13">
</div>

<!-- Tuya -->
<div class="field device-config" id="config-tuya">
    <label>IP do dispositivo</label>
    <input type="text" placeholder="192.168.0.50">
</div>

</div>
    <button class="add-btn">Adicionar</button>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {

    const select = document.getElementById('device-type');
    const configs = document.querySelectorAll('.device-config');
    const addBtn = document.querySelector('.add-btn');

    // ===== MOSTRAR CONFIG PELO TIPO =====
    select.addEventListener('change', () => {
        configs.forEach(c => c.style.display = 'none');

        const selected = select.value;
        if (selected) {
            const active = document.getElementById(`config-${selected}`);
            if (active) active.style.display = 'block';
        }
    });

    // ===== BOTÃO ADICIONAR =====
    addBtn.addEventListener('click', (e) => {
        e.preventDefault(); // evita submit de form

        const name = document.getElementById('device-name').value.trim();
        const type = document.getElementById('device-type').value;
        const house_id = document.getElementById("house_id")?.value;

        if (!name || !type || !house_id) {
            alert("Preencha nome, tipo e casa");
            return;
        }

        let config = {};

        if (type === "lan") {
            const mac = document.querySelector('#config-lan input').value.trim();
            if (!mac) return alert("Informe o MAC");
            config.mac = mac;
        }

        if (type === "arduino") {
            const inputs = document.querySelectorAll('#config-arduino input');
            const port = inputs[0].value.trim();
            const pin = inputs[1].value.trim();
            if (!port || !pin) return alert("Informe porta e pino");
            config.port = port;
            config.pin = pin;
        }

        if (type === "tuya") {
            const ip = document.querySelector('#config-tuya input').value.trim();
            if (!ip) return alert("Informe o IP");
            config.ip = ip;
        }

        fetch('/api/devices', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name,
                device_type: type,
                house_id,
                config
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                window.location.href = "/";
            }
        })
        .catch(err => {
            console.error(err);
            alert("Erro ao salvar dispositivo");
        });
    });

});
</script>


{% endblock %}
