{% extends "base.html" %}
{% block title %}Dash Residencial{% endblock %}
{% block page_title %}ResidÃªncia{% endblock %}
{% block content %}

{% for d in devices %}
<div class="device-card">
    <h3>{{ d.name }}</h3>

    <div class="device-actions">
        <label class="switch">
            <input type="checkbox"
                   {% if d.state %}checked{% endif %}
                   onchange="toggleDevice({{ d.id }}, this)">
            <span class="slider"></span>
        </label>

        <button class="btn-delete"
                onclick="deleteDevice({{ d.id }})">
            Excluir
        </button>
    </div>
</div>
{% endfor %}

<div style="margin-top: 30px;">
<button class="add-disp"
onclick="window.location.href='/add_dispositivo?user_id={{ user_id }}&house_id={{ house_id }}'">
Adicionar dispositivo
</button>
</div>

<script>
function toggleDevice(deviceId, checkbox) {
    const state = checkbox.checked;

    const params = new URLSearchParams(window.location.search);

    fetch(`/device/${deviceId}/toggle?${params.toString()}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ state })
    })
    .then(res => {
        if (!res.ok) throw new Error("Erro ao enviar comando");
        return res.json();
    })
    .catch(err => {
        console.error(err);
        alert("Erro ao comunicar com o servidor");
        checkbox.checked = !checkbox.checked;
    });
}

function deleteDevice(deviceId) {
    if (!confirm("Excluir este dispositivo?")) return;

    const params = new URLSearchParams(window.location.search);

    fetch(`/api/devices/${deviceId}?${params.toString()}`, {
        method: "DELETE"
    })
    .then(res => {
        if (!res.ok) throw new Error("Erro ao excluir");
        location.reload();
    });
}
</script>

{% endblock %}
