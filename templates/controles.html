{% extends "base.html" %}
{% block title %}Dash Residencial{% endblock %}
{% block page_title %}ResidÃªncia{% endblock %}
{% block content %}

<div class="devices-grid">

    {% for device in devices %}
        <div class="device-card">
            <h3>{{ device.name }}</h3>

            <div class="hud-line"></div>

            <label class="switch">
                <input type="checkbox"
                    onchange="toggleDevice(this, {{ device.id }})">
                <span class="slider"></span>
            </label>
        </div>
    {% endfor %}

</div>

<div style="margin-top: 30px;">
<button class="add-disp"
onclick="window.location.href='/add_dispositivo?user_id={{ user.id }}&role={{ user.role }}'">
Adicionar dispositivo
</button>
</div>

{% for d in devices %}
<div class="device-card">
    <h3>{{ d.name }}</h3>

    <button onclick="toggleDevice({{ d.id }})">Ligar / Desligar</button>

    <button class="danger" onclick="deleteDevice({{ d.id }})">
        ðŸ—‘ Remover
    </button>
</div>
{% endfor %}

<script>

function deleteDevice(deviceId) {
    if (!confirm("Deseja remover este dispositivo?")) return;

    fetch(`/api/devices/${deviceId}`, {
        method: "DELETE"
    })
    .then(r => r.json())
    .then(data => {
        if (data.status) {
            alert("Dispositivo removido");
            location.reload();
        } else {
            alert(data.error || "Erro ao remover");
        }
    });
}

function toggleDevice(checkbox, id) {
    fetch(`/device/${id}/toggle`, { method: 'POST' });
}

document.addEventListener('DOMContentLoaded', () => {
    const btn = document.querySelector('.add-disp');

    if (btn) {
        btn.addEventListener('click', () => {
            window.location.href = "/add_dispositivo";
        });
    }
});
</script>

{% endblock %}
